# Kustomization configuration for staging environment
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: stage-orion-service
labels:
  - pairs:
      environment: staging
    includeSelectors: false
    includeTemplates: true

resources:
  - ../../base

# Patches for different Kubernetes resources
patches:
  # Patch for Deployment configuration
  - target:
      kind: Deployment
      name: orion-service
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: orion-service
        labels:
          app: orion
      spec:
        replicas: 2
        template:
          metadata:
            labels:
              app: orion
            annotations:
              kubernetes.io/change-cause: Update to 399600302704.dkr.ecr.ap-south-1.amazonaws.com/greatify-orion-service:latest-stage
          spec:
            containers:
              - name: orion
                image: 399600302704.dkr.ecr.ap-south-1.amazonaws.com/greatify-orion-service:latest-stage
                resources:
                  limits:
                    memory: "2048Mi"
                    cpu: "1000m"
                  requests:
                    memory: "1024Mi"
                    cpu: "500m"

  # Patch for Celery Deployment configuration
  - target:
      kind: Deployment
      name: orion-celery-service
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: orion-celery-service
        labels:
          app: orion-celery
      spec:
        replicas: 2
        template:
          metadata:
            labels:
              app: orion-celery
            annotations:
              kubernetes.io/change-cause: Update to 399600302704.dkr.ecr.ap-south-1.amazonaws.com/greatify-orion-service:latest-stage
          spec:
            containers:
              - name: orion-celery
                image: 399600302704.dkr.ecr.ap-south-1.amazonaws.com/greatify-orion-service:latest-stage
                resources:
                  requests:
                    cpu: 600m
                    memory: 800Mi
                  limits:
                    cpu: 800m
                    memory: 1000Mi

  # Patch for Ingress configuration
  - target:
      kind: Ingress
      name: orion-ingress
    patch: |-
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: orion-ingress
        annotations:
          alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-south-1:399600302704:certificate/fc7615a3-19ad-4aa1-988a-ac4ce7e18986
          alb.ingress.kubernetes.io/cors-allow-origin: >-
            https://stage.greatify.us,https://www.stage.greatify.us,https://*.stage.greatify.us
      spec:
        rules:
          - http:
              paths:
                - path: /api/v1/
                  pathType: Prefix
                  backend:
                    service:
                      name: orion-service
                      port:
                        number: 80
                - path: /api/v1/health/
                  pathType: Prefix
                  backend:
                    service:
                      name: orion-service
                      port:
                        number: 80
        tls:
          - hosts:
              - stage.greatify.us
            secretName: tls-secret

  # Patch for SecretProviderClass configuration
  - target:
      kind: SecretProviderClass
      name: orion-secrets
    patch: |-
      apiVersion: secrets-store.csi.x-k8s.io/v1
      kind: SecretProviderClass
      metadata:
        name: orion-secrets
      spec:
        parameters:
          objects: |
            - objectName: arn:aws:secretsmanager:ap-south-1:399600302704:secret:orion-secrets-stage-Cs3Vge
              objectAlias: ".env"
              objectType: "secretsmanager"
