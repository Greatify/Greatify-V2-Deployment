# Kustomization configuration for production environment
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: prod-orion-service
labels:
  - pairs:
      environment: production
    includeSelectors: false
    includeTemplates: true

resources:
  - ../../base

# Patches for different Kubernetes resources
patches:
  # Patch for Deployment configuration
  - target:
      kind: Deployment
      name: orion-service
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: orion-service
        labels:
          app: orion
      spec:
        replicas: 3
        template:
          metadata:
            labels:
              app: orion
            annotations:
              kubernetes.io/change-cause: Update to 399600302704.dkr.ecr.ap-south-1.amazonaws.com/greatify-orion-service:latest-prod
          spec:
            containers:
              - name: orion
                image: 399600302704.dkr.ecr.ap-south-1.amazonaws.com/greatify-orion-service:latest-prod
                resources:
                  limits:
                    memory: "4096Mi"
                    cpu: "2000m"
                  requests:
                    memory: "2048Mi"
                    cpu: "1000m"

  # Patch for Celery Deployment configuration
  - target:
      kind: Deployment
      name: orion-celery-service
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: orion-celery-service
        labels:
          app: orion-celery
      spec:
        replicas: 3
        template:
          metadata:
            labels:
              app: orion-celery
            annotations:
              kubernetes.io/change-cause: Update to 399600302704.dkr.ecr.ap-south-1.amazonaws.com/greatify-orion-service:latest-prod
          spec:
            containers:
              - name: orion-celery
                image: 399600302704.dkr.ecr.ap-south-1.amazonaws.com/greatify-orion-service:latest-prod
                resources:
                  requests:
                    cpu: 1000m
                    memory: 1500Mi
                  limits:
                    cpu: 1500m
                    memory: 2000Mi

  # Patch for RabbitMQ with higher resources for production
  - target:
      kind: Deployment
      name: orion-rabbitmq
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: orion-rabbitmq
        labels:
          app: orion-rabbitmq
      spec:
        template:
          spec:
            containers:
              - name: orion-rabbitmq
                resources:
                  requests:
                    memory: "500Mi"
                    cpu: "500m"
                  limits:
                    memory: "1000Mi"
                    cpu: "1000m"

  # Patch for Redis with higher resources for production
  - target:
      kind: Deployment
      name: orion-redis
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: orion-redis
        labels:
          app: orion-redis
      spec:
        template:
          spec:
            containers:
              - name: orion-redis
                resources:
                  limits:
                    memory: "1024Mi"
                    cpu: "500m"
                  requests:
                    memory: "512Mi"
                    cpu: "250m"

  # Patch for Ingress configuration
  - target:
      kind: Ingress
      name: orion-ingress
    patch: |-
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: orion-ingress
        annotations:
          alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-south-1:399600302704:certificate/fc7615a3-19ad-4aa1-988a-ac4ce7e18986
          alb.ingress.kubernetes.io/cors-allow-origin: >-
            https://greatify.us,https://www.greatify.us,https://*.greatify.us,https://*.learnx.greatify.us,https://*.examx.greatify.us,https://*.placex.greatify.us,https://*.managex.greatify.us
      spec:
        rules:
          - http:
              paths:
                - path: /api/v1/
                  pathType: Prefix
                  backend:
                    service:
                      name: orion-service
                      port:
                        number: 80
                - path: /api/v1/health/
                  pathType: Prefix
                  backend:
                    service:
                      name: orion-service
                      port:
                        number: 80
        tls:
          - hosts:
              - greatify.us
            secretName: tls-secret

  # Patch for SecretProviderClass configuration
  - target:
      kind: SecretProviderClass
      name: orion-secrets
    patch: |-
      apiVersion: secrets-store.csi.x-k8s.io/v1
      kind: SecretProviderClass
      metadata:
        name: orion-secrets
      spec:
        parameters:
          objects: |
            - objectName: arn:aws:secretsmanager:ap-south-1:399600302704:secret:orion-secrets-prod-Cs3Vge
              objectAlias: ".env"
              objectType: "secretsmanager"
